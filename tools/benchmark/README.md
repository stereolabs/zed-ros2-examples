# Stereolabs ZED Camera - ROS 2 Wrapper Benchmark Tool

This package provides benchmarking tools for evaluating the performance of ZED ROS 2 integrations. It includes two benchmark nodes: `zed_topic_benchmark`, which measures the throughput and stability of published ZED topics, and `zed_hardware_load_benchmark`, which monitors system resource usage such as CPU and GPU while the ZED pipeline is running. Together, these nodes help assess both communication performance and hardware load under realistic operating conditions.

## ZED Topic Benchmark node

It can be used to test frequency and bandwidth of topics and eventually plot the realtime values.

For each topic the following information will be available:

* Topic type
* Real time frequency
* Window average frequency
* Topic size
* Real time topic bandwidth
* Window average topic bandwidth

The node publishes a message on the topic `<name_of_the_topic_to_test>_stats` containing all the information to be eventually plotted.

When the node is killed, results are published in a text file, containing : 

* Topic name and type
* Window average topic frequency (with standard deviation)
* Window average topic bandwidth

**Note:** This tool is not available for Foxy distribution because it misses an important feature required to subscribe to "generic topics".

### Parameters

* `topic_name`: name of the topic to test
* `avg_win_size`: size of the mobile window for the calculation of the average. [Default: `500`]
* `results_file_path`: path file on which benchmark results are published.  

### Custom message

The node published a message on the topic `<name_of_the_topic_to_test>_stats` containing the previous information to be plotted.
The topic is a custom message of type `BenchmarkStatsStamped` defined as:

```
# Standard Header
std_msgs/Header header

# Instant Frequency
float32 topic_freq
# Average Frequency
float32 topic_avg_freq

# Instant Bandwidth
float32 topic_bw
# Average Bandwidth
float32 topic_avg_bw
```

### Usage

Open a new terminal console and start the benchmark node:

```bash
$ ros2 run zed_benchmark zed_topic_benchmark --ros-args -p topic_name:=<name_of_the_topic_to_test> -p results_file_path:=<path> 
```

for example:

```bash
ros2 run zed_benchmark zed_topic_benchmark --ros-args -p topic_name:=/zed2i/zed_node/rgb/color/rect/image -p results_file_path:=benchmark_image_topic.txt
```

The node will print all the topic information on the console:

```bash
[INFO] [1665764376.862143962] [topic_benchmark]: ***** Benchmark parameters *****
[INFO] [1665764376.862355022] [topic_benchmark]: * Topic name: /zed2i/zed_node/rgb/color/rect/image
[INFO] [1665764376.862462857] [topic_benchmark]: Average window size: 500
[INFO] [1665764376.862476172] [topic_benchmark]: *** START BENCHMARK ***
[INFO] [1665764376.863484009] [topic_benchmark]: Advertised on topic: /zed/zed_node/rgb/color/rect/image_stats
[INFO] [1665764376.863484254] [topic_benchmark]: Average window size: 500
[INFO] [1665764376.863484126] [topic_benchmark]: ROS Log: 0
[INFO] [1665764376.863484785] [topic_benchmark]: Results File path: benchmark_image_topic.txt
[INFO] [1665764377.363430211] [topic_benchmark]: Found topic: '/zed/zed_node/rgb/color/rect/image' of type: 'sensor_msgs/msg/Image'
#119 - Freq: 6.01 Hz (Avg: 13.49 Hz) - Bandwidth: 42.28 Mbps (Avg: 94.87 Mbps) - Msg size: 0.88 MB
```
When stopped, results can be found directly in the provided input text file: 

```json
Topic Name: /zed2i/zed_node/rgb/color/rect/image
Topic Type: sensor_msgs/msg/Image
Average Frequency: 10.5915
Average Frequency Standard Deviation: 0.755081
Average Bandwidth: 148.293
-----------------------------
```

## ZED Hardware Load Benchmark node

This benchmark can be used to evaluate the CPU, GPU, and RAM usage generated by the ZED ROS 2 wrapper. For accurate and reproducible results, it is recommended to run the benchmark with only the wrapper node active, ensuring that resource usage from other processes does not affect the measurements.

When the node is killed, results are published in a text file, containing : 

* Average CPU load.
* Average GPU load.
* Overall Ram load.

### Parameters

* `cpu_gpu_load_period`: time period on which to request a cpu / gpu / ram load measurement. 
* `results_file_path`: path file on which hardawre benchmark results are published.  

### Usage

Open a new terminal console and start the hardware load benchmark node:

```bash
$ ros2 run zed_benchmark zed_hardware_load_benchmark --ros-args -p cpu_gpu_load_period:=<load period in ms> -p results_file_path:=<path> 
```

for example:

```bash
$ ros2 run zed_benchmark zed_hardware_load_benchmark --ros-args -p cpu_gpu_load_period:=50 -p results_file_path:=hw_results_test.txt 
```
The node will print all the topic information on the console:

```bash
[INFO] [1767185660.427638592] [hardware_load_benchmark]: ***** Load Benchmark parameters *****
[INFO] [1767185660.428119296] [hardware_load_benchmark]: CPU/GPU Load Period 50
[INFO] [1767185660.428200992] [hardware_load_benchmark]: Results File path: hw_results_test.txt
[INFO] [1767185660.428261248] [hardware_load_benchmark]: ROS Log: 0
[INFO] [1767185660.428345952] [hardware_load_benchmark]: HardwareLoadComponent started. Sampling every 50 ms, output: hw_results_test.txt
# - CPU Load: 24.00% - GPU Load: 72.00 % - RAM Load: 38.66
```

When stopped, results can be found directly in the provided input text file: 

```json
Average CPU Load: 23.198891
Average GPU Load: 60.0423
RAM Load: 38.6602
-----------------------------
```

## Advanced

### Composition 

The package provides also ROS 2 components called `stereolabs::TopicBenchmarkComponent` and `stereolabs::HardwareLoadBenchmarkComponent` to be used with [Composition](https://docs.ros.org/en/humble/Tutorials/Intermediate/Composition.html) to test [Intra Process Communication (IPC)](https://design.ros2.org/articles/intraprocess_communications.html) performances.

In the launch folder of this package, an example launch file (__zed_wrapper_benchmark_test.launch.py__) template is provided. It is based on the [zed_multi_camera](https://github.com/stereolabs/zed-ros2-examples/tree/master/tutorials/zed_multi_camera) example and is intended to enable benchmarking of the ZED ROS 2 wrapper in both single-camera and multi-camera configurations using composition. This launcher can be used as a template for creating custom benchmark tests. The benchmark component nodes are exposed with the same parameters described in the previous sections.

The example launcher is designed to offer modularity and automation in the selection of topics to be monitored during benchmarking. It accepts a `ros_params_override_path` input parameter, which specifies the path to a ROS 2 wrapper YAML configuration file. This file allows users to configure the ROS 2 wrapper as needed for their test scenario. The launcher starts the multi-camera ROS 2 wrapper setup using the provided configuration and automatically enables benchmarking for topics corresponding to the activated SDK modules (e.g. Depth, Positional Tracking, Object Detection) across all available cameras.

By default, standard image capture topics are always monitored. If depth is enabled for example, point cloud topics are automatically included. Similarly, enabling positional tracking or object detection will activate monitoring of their respective topics. Users may also add additional topics as required for specific test cases. The launcher is designed to cover the most commonly monitored topics for performance evaluation while remaining extensible.

The hardware load benchmark node is also enabled by default in the example launcher. While the benchmark nodes are running, status messages are printed to the terminal, and monitored topics performance statistics are published on dedicated topics, allowing real-time monitoring as described earlier. When the launcher is stopped, both benchmark nodes write the collected results to the output text file specified as input.

An additional node, `performance_test_duration_node`, is also available and is enabled in the template launcher when the `performance_test_duration` parameter is set to a value greater than zero (default value). This parameter allows users to define a fixed duration for the benchmark. In this mode, the node acts as a supervisory process and automatically terminates all ROS 2 processes started by the launcher once the specified duration (`performance_test_duration` seconds) has elapsed. Benchmark results can then also be retrieved in the provided text files.

### Test Script

The package also provides a Bash script template that leverages the composition launcher together with the `performance_test_duration` node to run batches of successive benchmark tests automatically. This approach enables systematic performance evaluation across different camera setups (single or multi-camera) and wrapper configurations.

The template script is located in the `scripts` directory of the package (*ros_wrapper_benchmark_test.sh*) and can be easily adapted to suit specific testing requirements. In its default form, the script defines three benchmark runs using 1, 2, and 4 cameras, all sharing the same wrapper configuration, providing a simple example of automated and repeatable performance testing.